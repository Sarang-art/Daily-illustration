<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tutorials Database</title>
  <style>
    :root {
      --bg: #ffe8ff;
      --card: #ffffff;
      --muted: #6c757d;
      --text: #212529;
      --accent: #f728dc;
      --border: #e0c0e0;
      --chip: #f8e8f8;
      --danger: #dc3545;
      --focus: #f728dc;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    header {
      padding: 28px 20px 12px;
      position: sticky; top: 0; backdrop-filter: saturate(1.2) blur(8px);
      background: linear-gradient(180deg, rgba(255,232,255,0.85), rgba(255,232,255,0.6) 70%, rgba(255,232,255,0));
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
    h1 { margin: 0; font-size: 1.5rem; letter-spacing: 0.2px; }
    .sub { color: var(--muted); font-size: 0.95rem; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
    .btn {
      appearance: none; border: 1px solid var(--border); background: #f8e8f8; color: var(--text);
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 550;
      transition: transform .04s ease, border-color .2s ease;
    }
    .btn:hover { border-color: #d8a0d8; background: #f0d8f0; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(180deg, #f8e0f8, #f0d0f0); border-color: #e0c0e0; }
    .btn.accent { background: #ffd0ff; border-color: var(--accent); color: #800080; }
    .btn.danger { background: #f8d7da; border-color: #f1aeb5; color: #58151c; }
    .btn.edit { background: #e0e0ff; border-color: #c0c0ff; color: #000080; }
    .btn.undo { background: #fff0e0; border-color: #ffd0a0; color: #804000; }

    main { display: grid; grid-template-columns: 1fr; gap: 18px; padding: 18px 0 40px; }
    @media (min-width: 980px) {
      main { grid-template-columns: 420px 1fr; align-items: start; }
    }

    form { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    fieldset { border: none; padding: 0; margin: 0; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }

    label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="url"], input[type="search"], input[type="number"], textarea, select {
      width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border);
      background: white; color: var(--text); outline: none; transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(247,40,220,0.15); }

    .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 6px; }

    .panel { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; }
    .list-head { display: flex; align-items: center; gap: 10px; justify-content: space-between; flex-wrap: wrap; margin-bottom: 8px; }
    .count { color: var(--muted); font-size: 0.9rem; }

    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .card { border: 1px solid var(--border); border-radius: 14px; overflow: hidden; background: white; display: flex; flex-direction: column; }
    .thumb { aspect-ratio: 4/3; width: 100%; object-fit: cover; background: #f8f0f8; }
    .card-b { padding: 12px; display: grid; gap: 8px; }
    .title { font-weight: 650; font-size: 1rem; line-height: 1.2; }
    .meta { color: var(--muted); font-size: 0.85rem; }
    .card-actions { display: flex; gap: 6px; margin-top: 2px; }

    .empty { color: var(--muted); text-align: center; padding: 28px 0; border: 1px dashed var(--border); border-radius: 12px; }

    .note { font-size: 0.85rem; color: var(--muted); margin-top: 8px; }

    .toast { position: fixed; right: 16px; bottom: 18px; background: #ffd0ff; color: #800080; border: 1px solid var(--accent); padding: 10px 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,.1); opacity: 0; transform: translateY(6px); transition: .3s ease; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); }

    .autocomplete-container { position: relative; }
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid var(--border);
      border-radius: 0 0 12px 12px;
      z-index: 10;
      display: none;
    }
    .autocomplete-suggestions.show { display: block; }
    .autocomplete-suggestion { padding: 8px 12px; cursor: pointer; }
    .autocomplete-suggestion:hover { background-color: #f8e8f8; }

    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip { background: var(--chip); padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
    .chip-remove { cursor: pointer; font-size: 0.86rem; color: var(--muted); margin-left: 4px; }

    .small { font-size: 0.85rem; color: var(--muted); }

    /* Details checklist styles */
    .details-title { font-size: 0.85rem; color: var(--muted); margin: 16px 0 8px; }
    .checklist { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .checklist-item { display: flex; align-items: center; gap: 6px; }
    .checklist-item input { width: auto; }
    .checklist-item label { margin: 0; font-size: 0.9rem; color: var(--text); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>Tutorials Database</h1>
          <div class="sub">Track tutorials: title, creator, link, thumbnail, subject, details, country and keywords</div>
        </div>
        <button class="btn" onclick="window.location.href='Index.html'">Back to Index</button>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="exportBtn" title="Download all entries as JSON">Export JSON</button>
        <label class="btn" id="importLabel">
          <span class="file-input">Import JSON
            <input type="file" id="importInput" accept="application/json" />
          </span>
        </label>
        <button class="btn" id="clearBtn" title="Remove all local data">Clear All (Local)</button>
        <input type="search" id="search" placeholder="Search by title, creator, subject, keywords..." aria-label="Search entries" />
      </div>
    </div>
  </header>

  <div class="wrap">
    <main>
      <!-- Form -->
      <section class="panel" aria-labelledby="form-title">
        <h2 id="form-title" style="margin: 4px 0 10px; font-size: 1.05rem; color: var(--muted);">Add / Edit Tutorial</h2>
        <form id="entryForm">
          <input type="hidden" id="editId" value="">
          <fieldset class="grid">
            <div>
              <label for="tutorialTitle">Tutorial Title *</label>
              <input id="tutorialTitle" name="tutorialTitle" type="text" required placeholder="e.g., Anatomy for beginners" />
            </div>

            <div>
              <label for="creator">Creator Name</label>
              <input id="creator" name="creator" type="text" placeholder="e.g., Sinix Design" />
            </div>

            <div>
              <label for="originalLink">Link to original</label>
              <input id="originalLink" name="originalLink" type="url" placeholder="https://..." />
            </div>

            <div>
              <label for="thumbnail">Thumbnail Image URL</label>
              <input id="thumbnail" name="thumbnail" type="url" placeholder="https://.../thumb.jpg" />
            </div>

            <div>
              <label for="subject">Subject</label>
              <input id="subject" name="subject" type="text" placeholder="e.g., Anatomy, Color, Composition..." />
            </div>

            <!-- Details checklist (kept) -->
            <div>
              <div class="details-title">Details</div>
              <div class="checklist">
                <div class="checklist-item">
                  <input type="checkbox" id="detail-women" name="details" value="Women">
                  <label for="detail-women">Women</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="detail-black" name="details" value="Black">
                  <label for="detail-black">Black</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="detail-indigenous" name="details" value="Indigenous">
                  <label for="detail-indigenous">Indigenous</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="detail-asian" name="details" value="Asian">
                  <label for="detail-asian">Asian</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="detail-disabled" name="details" value="Disabled">
                  <label for="detail-disabled">Disabled</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="detail-lgbtqiap" name="details" value="LGBTQIAP+">
                  <label for="detail-lgbtqiap">LGBTQIAP+</label>
                </div>
              </div>
            </div>

            <!-- Country autocomplete -->
            <div class="autocomplete-container">
              <label for="country">Country</label>
              <input id="country" name="country" type="text" placeholder="Start typing to see suggestions" />
              <div id="country-suggestions" class="autocomplete-suggestions"></div>
            </div>

            <!-- Keywords (dynamic suggestions) -->
            <div class="autocomplete-container">
              <label for="keywords-input">Keywords</label>
              <input id="keywords-input" type="text" placeholder="Type and press Enter to add keywords" autocomplete="off" />
              <div id="keywords-suggestions" class="autocomplete-suggestions"></div>
              <div id="keywords-chips" class="chips" aria-live="polite"></div>
              <input type="hidden" id="keywords" name="keywords" value="">
              <div class="small">Add multiple keywords. Suggestions come from prior keywords you've used.</div>
            </div>

          </fieldset>

          <div class="actions">
            <button type="button" class="btn undo" id="undoBtn" style="display: none;">Undo Changes</button>
            <button type="button" class="btn" id="cancelEditBtn" style="display: none;">Cancel</button>
            <button type="reset" class="btn">Reset</button>
            <button type="submit" class="btn accent" id="submitBtn">Add Tutorial</button>
          </div>
          <p class="note">Entries are saved in your browser localStorage. Use <em>Export JSON</em> to save a file. Import merges non-duplicate items.</p>
        </form>
      </section>

      <!-- List -->
      <section class="panel" aria-labelledby="list-title">
        <div class="list-head">
          <h2 id="list-title" style="margin: 0; font-size: 1.05rem; color: var(--muted);">Tutorials</h2>
          <div class="count" id="count">0 items</div>
        </div>
        <div id="cards" class="cards" aria-live="polite"></div>
        <div id="empty" class="empty" hidden>No tutorials yet. Add your first one on the left!</div>
      </section>
    </main>
  </div>

  <!-- Delete modal -->
  <div class="modal" id="deleteModal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; align-items:center; justify-content:center; z-index:200; background: rgba(0,0,0,0.5);">
    <div style="background:white; padding:18px; border-radius:12px; max-width:420px;">
      <p>Are you sure you want to delete this tutorial?</p>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button class="btn" id="cancelDeleteBtn">Cancel</button>
        <button class="btn danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // -------------------------
    // Storage & utilities
    // -------------------------
    const STORAGE_KEY = 'tutorialEntries.v1';
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    let state = [];
    let originalEntry = null;
    let entryToDelete = null;

    // Country list
    const countries = [
      "Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia",
      "Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan",
      "Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Côte d'Ivoire",
      "Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros",
      "Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador",
      "Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon",
      "Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Holy See",
      "Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan",
      "Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya",
      "Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands",
      "Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique",
      "Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea",
      "North Macedonia","Norway","Oman","Pakistan","Palau","Panama","Papua New Guinea","Paraguay","Peru","Philippines",
      "Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines",
      "Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore",
      "Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan",
      "Suriname","Sweden","Switzerland","Syria","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago",
      "Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States",
      "Uruguay","Uzbekistan","Vanuatu","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"
    ];

    // Base keywords (seed)
    const baseKeywords = [
      "Beginner","Intermediate","Advanced","Workflow","Tutorial Series","Step-by-Step","Reference","Tips","Tricks","Tooling"
    ];

    function loadEntries() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }
    function saveEntries(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }
    function toast(msg) {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1600);
    }
    function escapeHtml(str='') {
      return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }
    function escapeAttr(str='') { return escapeHtml(str); }

    // -------------------------
    // Keyword utilities (dynamic)
    // -------------------------
    function keywordsFromState() {
      const map = new Map();
      for (const e of state) {
        if (!e.keywords) continue;
        e.keywords.split(',').map(k => k.trim()).filter(Boolean).forEach(k => {
          const key = k.toLowerCase();
          if (!map.has(key)) map.set(key, k);
        });
      }
      return Array.from(map.values());
    }
    function combinedKeywordSource() {
      const used = keywordsFromState();
      const lower = new Set(used.map(s => s.toLowerCase()));
      const out = [...used];
      for (const b of baseKeywords) {
        if (!lower.has(b.toLowerCase())) out.push(b);
      }
      return out;
    }
    function getKeywordSuggestions(query, limit = 8) {
      if (!query) return combinedKeywordSource().slice(0, limit);
      const q = query.toLowerCase();
      const src = combinedKeywordSource();
      const matches = src.filter(s => s.toLowerCase().includes(q));
      matches.sort((a,b) => {
        const la = a.toLowerCase(), lb = b.toLowerCase();
        const pa = la.startsWith(q) ? 0 : 1;
        const pb = lb.startsWith(q) ? 0 : 1;
        if (pa !== pb) return pa-pb;
        return la.localeCompare(lb);
      });
      return matches.slice(0, limit);
    }

    // -------------------------
    // Autocomplete setup (country)
    // -------------------------
    function setupAutocomplete(inputElement, suggestionsElement, data) {
      inputElement.addEventListener('input', function() {
        const value = this.value.trim();
        if (!value) {
          suggestionsElement.innerHTML = '';
          suggestionsElement.classList.remove('show');
          return;
        }
        const val = value.toLowerCase();
        const matches = data.filter(item => item.toLowerCase().includes(val)).slice(0, 8);
        if (matches.length) {
          suggestionsElement.innerHTML = matches.map(item => '<div class="autocomplete-suggestion">' + escapeHtml(item) + '</div>').join('');
          suggestionsElement.classList.add('show');
        } else {
          suggestionsElement.innerHTML = '';
          suggestionsElement.classList.remove('show');
        }
      });

      suggestionsElement.addEventListener('click', function(e) {
        if (e.target.classList.contains('autocomplete-suggestion')) {
          inputElement.value = e.target.textContent;
          suggestionsElement.innerHTML = '';
          suggestionsElement.classList.remove('show');
          inputElement.focus();
        }
      });

      document.addEventListener('click', function(e) {
        if (e.target !== inputElement) suggestionsElement.classList.remove('show');
      });
    }

    // -------------------------
    // Keyword chips management
    // -------------------------
    function addKeywordChip(keyword) {
      if (!keyword) return;
      const chipsContainer = $('#keywords-chips');
      const existing = Array.from(chipsContainer.querySelectorAll('.chip')).map(c => c.textContent.replace('×','').trim().toLowerCase());
      if (existing.includes(keyword.toLowerCase())) return;
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = escapeHtml(keyword) + ' <span class="chip-remove" data-keyword="' + escapeAttr(keyword) + '">×</span>';
      chipsContainer.appendChild(chip);
      chip.querySelector('.chip-remove').addEventListener('click', function() {
        chip.remove();
        updateKeywordsHiddenField();
      });
      updateKeywordsHiddenField();
    }

    function updateKeywordsHiddenField() {
      const chips = Array.from($('#keywords-chips').querySelectorAll('.chip'));
      const keywords = chips.map(chip => chip.textContent.replace('×','').trim()).filter(Boolean);
      $('#keywords').value = keywords.join(',');
    }

    function initKeywordsInput() {
      const input = $('#keywords-input');
      const suggestionsEl = $('#keywords-suggestions');

      input.addEventListener('input', function() {
        const q = this.value.trim();
        const matches = getKeywordSuggestions(q, 8);
        if (matches.length) {
          suggestionsEl.innerHTML = matches.map(m => '<div class="autocomplete-suggestion">' + escapeHtml(m) + '</div>').join('');
          suggestionsEl.classList.add('show');
        } else {
          suggestionsEl.innerHTML = '';
          suggestionsEl.classList.remove('show');
        }
      });

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const value = this.value.trim();
          if (value) addKeywordChip(value);
          this.value = '';
          suggestionsEl.classList.remove('show');
        } else if (e.key === 'Tab' && this.value.trim()) {
          const first = suggestionsEl.querySelector('.autocomplete-suggestion');
          if (first) {
            e.preventDefault();
            addKeywordChip(first.textContent);
            this.value = '';
            suggestionsEl.classList.remove('show');
          }
        }
      });

      suggestionsEl.addEventListener('click', function(e) {
        if (e.target.classList.contains('autocomplete-suggestion')) {
          addKeywordChip(e.target.textContent);
          input.value = '';
          suggestionsEl.classList.remove('show');
        }
      });

      document.addEventListener('click', function(e) {
        if (e.target !== input) suggestionsEl.classList.remove('show');
      });
    }

    // -------------------------
    // Rendering
    // -------------------------
    function render(entries, query = '') {
      const cards = $('#cards');
      const empty = $('#empty');
      const count = $('#count');

      const q = query.trim().toLowerCase();
      const filtered = q ? entries.filter(e => {
        return (e.tutorialTitle && e.tutorialTitle.toLowerCase().includes(q)) ||
               (e.creator && e.creator.toLowerCase().includes(q)) ||
               (e.subject && e.subject.toLowerCase().includes(q)) ||
               (e.country && e.country.toLowerCase().includes(q)) ||
               (e.details && e.details.toLowerCase().includes(q)) ||
               (e.keywords && e.keywords.toLowerCase().includes(q));
      }) : entries;

      count.textContent = filtered.length + ' item' + (filtered.length === 1 ? '' : 's');

      if (!filtered.length) {
        cards.innerHTML = '';
        empty.hidden = false;
        return;
      }
      empty.hidden = true;

      cards.innerHTML = filtered.map(e => cardTemplate(e)).join('');

      // wire buttons
      $$('#cards [data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const id = btn.getAttribute('data-id');
          entryToDelete = state.find(x => x.id === id);
          if (entryToDelete) {
            $('#deleteModal').style.display = 'flex';
            $('#deleteModal').style.alignItems = 'center';
            $('#deleteModal').style.justifyContent = 'center';
          }
        });
      });
      $$('#cards [data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const id = btn.getAttribute('data-id');
          const entry = state.find(x => x.id === id);
          if (entry) editEntry(entry);
        });
      });
    }

    function cardTemplate(e) {
      const img = e.thumbnail ? '<img class="thumb" alt="' + escapeAttr(e.tutorialTitle) + '" src="' + escapeAttr(e.thumbnail) + '" onerror="this.src=\'\'; this.style.display=\'none\'">' : '<div class="thumb" aria-hidden="true"></div>';
      const linkPart = e.originalLink ? '<a href="' + escapeAttr(e.originalLink) + '" target="_blank" rel="noopener" class="btn primary">Open</a>' : '';
      const metaParts = [];
      if (e.creator) metaParts.push(escapeHtml(e.creator));
      if (e.subject) metaParts.push(escapeHtml(e.subject));
      const meta = metaParts.length ? '<div class="meta">' + metaParts.join(' · ') + '</div>' : '';
      const country = e.country ? '<div class="meta">Country: ' + escapeHtml(e.country) + '</div>' : '';
      const detailsChips = e.details ? e.details.split(',').map(d => '<span class="chip">' + escapeHtml(d.trim()) + '</span>').join('') : '';
      const keywordChips = e.keywords ? e.keywords.split(',').map(k => '<span class="chip">' + escapeHtml(k.trim()) + '</span>').join('') : '';
      return ''
        + '<article class="card" aria-label="' + escapeAttr(e.tutorialTitle) + '">'
        + img
        + '<div class="card-b">'
        + '<div class="title">' + escapeHtml(e.tutorialTitle) + '</div>'
        + meta
        + country
        + (detailsChips ? '<div class="chips">' + detailsChips + '</div>' : '')
        + (keywordChips ? '<div class="chips">' + keywordChips + '</div>' : '')
        + '<div class="card-actions">'
        + linkPart
        + '<button class="btn edit" data-action="edit" data-id="' + escapeAttr(e.id) + '" title="Edit tutorial">Edit</button>'
        + '<button class="btn danger" data-action="delete" data-id="' + escapeAttr(e.id) + '" title="Delete tutorial">Delete</button>'
        + '</div></div></article>';
    }

    // -------------------------
    // Edit / cancel / undo
    // -------------------------
    function editEntry(entry) {
      originalEntry = {...entry};
      $('#editId').value = entry.id;
      $('#tutorialTitle').value = entry.tutorialTitle || '';
      $('#creator').value = entry.creator || '';
      $('#originalLink').value = entry.originalLink || '';
      $('#thumbnail').value = entry.thumbnail || '';
      $('#subject').value = entry.subject || '';
      $('#country').value = entry.country || '';

      // set details checkboxes
      $$('#entryForm input[name="details"]').forEach(checkbox => {
        checkbox.checked = entry.details && entry.details.split(',').map(s => s.trim()).includes(checkbox.value);
      });

      // keywords chips
      $('#keywords-chips').innerHTML = '';
      if (entry.keywords) {
        entry.keywords.split(',').map(k => k.trim()).filter(Boolean).forEach(k => addKeywordChip(k));
      }

      $('#submitBtn').textContent = 'Update Tutorial';
      $('#cancelEditBtn').style.display = 'block';
      $('#undoBtn').style.display = 'block';
      document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
      $('#entryForm').reset();
      $('#editId').value = '';
      $('#submitBtn').textContent = 'Add Tutorial';
      $('#cancelEditBtn').style.display = 'none';
      $('#undoBtn').style.display = 'none';
      $('#keywords-chips').innerHTML = '';
      $('#keywords').value = '';
      $$('#entryForm input[name="details"]').forEach(cb => cb.checked = false);
      originalEntry = null;
    }

    function undoChanges() {
      if (!originalEntry) return;
      const index = state.findIndex(e => e.id === originalEntry.id);
      if (index !== -1) {
        state[index] = {...originalEntry};
        saveEntries(state);
        render(state, $('#search').value);
        toast('Changes undone');
      }
      cancelEdit();
    }

    // -------------------------
    // Initialization & handlers
    // -------------------------
    state = loadEntries();
    render(state);

    // Country autocomplete
    setupAutocomplete($('#country'), $('#country-suggestions'), countries);

    // Keywords input
    initKeywordsInput();

    // Submit handler
    $('#entryForm').addEventListener('submit', (ev) => {
      ev.preventDefault();

      // Get checked details from checklist
      const details = Array.from(document.querySelectorAll('#entryForm input[name="details"]:checked'))
        .map(checkbox => checkbox.value)
        .join(',');

      const entry = {
        id: $('#editId').value || (crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2)),
        createdAt: $('#editId').value ? (state.find(e => e.id === $('#editId').value)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
        tutorialTitle: $('#tutorialTitle').value.trim(),
        creator: $('#creator').value.trim(),
        originalLink: $('#originalLink').value.trim(),
        thumbnail: $('#thumbnail').value.trim(),
        subject: $('#subject').value.trim(),
        details: details,
        country: $('#country').value.trim(),
        keywords: $('#keywords').value.trim()
      };

      if (!entry.tutorialTitle) {
        toast('Please add the tutorial title.');
        return;
      }

      if ($('#editId').value) {
        const idx = state.findIndex(e => e.id === $('#editId').value);
        if (idx !== -1) {
          state[idx] = entry;
          toast('Tutorial updated');
        }
      } else {
        state.unshift(entry);
        toast('Tutorial added');
      }

      saveEntries(state);
      $('#keywords-input').value = '';
      $('#keywords-suggestions').innerHTML = '';
      render(state, $('#search').value);
      cancelEdit();
    });

    // Export
    $('#exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `tutorials-${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('JSON exported');
    });

    // Import (maps common field names)
    $('#importInput').addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        const incoming = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
        if (!incoming.length) throw new Error('No items found');
        const byKey = new Map(state.map(it => [it.id, it]));
        let added = 0;
        for (const it of incoming) {
          const id = it.id || (crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2));
          if (!byKey.has(id)) {
            state.push({
              id,
              createdAt: it.createdAt || new Date().toISOString(),
              tutorialTitle: it.tutorialTitle || it.title || it.name || '',
              creator: it.creator || it.author || '',
              originalLink: it.originalLink || it.link || it.website || '',
              thumbnail: it.thumbnail || it.imageUrl || it.thumb || '',
              subject: it.subject || it.topic || '',
              details: it.details || '',
              country: it.country || it.origin || '',
              keywords: it.keywords || ''
            });
            byKey.set(id, true);
            added++;
          }
        }
        saveEntries(state);
        render(state, $('#search').value);
        toast('Imported ' + added + ' item' + (added === 1 ? '' : 's'));
      } catch (err) {
        console.error(err);
        toast('Import failed: invalid JSON');
      } finally {
        ev.target.value = '';
      }
    });

    // Search
    $('#search').addEventListener('input', (e) => {
      render(state, e.target.value);
    });

    // Clear all
    $('#clearBtn').addEventListener('click', () => {
      if (!confirm('This will remove all tutorials stored locally on this browser. Continue?')) return;
      state.splice(0, state.length);
      saveEntries(state);
      render(state);
      toast('All local data cleared');
    });

    // Cancel / undo buttons
    $('#cancelEditBtn').addEventListener('click', cancelEdit);
    $('#undoBtn').addEventListener('click', undoChanges);

    // Delete flow
    $('#cancelDeleteBtn').addEventListener('click', () => {
      $('#deleteModal').style.display = 'none';
      entryToDelete = null;
    });
    $('#confirmDeleteBtn').addEventListener('click', () => {
      if (entryToDelete) {
        const idx = state.findIndex(x => x.id === entryToDelete.id);
        if (idx > -1) {
          state.splice(idx, 1);
          saveEntries(state);
          render(state, $('#search').value);
          toast('Tutorial removed');
        }
      }
      $('#deleteModal').style.display = 'none';
      entryToDelete = null;
    });

    // Close modal if clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === $('#deleteModal')) {
        $('#deleteModal').style.display = 'none';
        entryToDelete = null;
      }
    });
  </script>
</body>
</html>
